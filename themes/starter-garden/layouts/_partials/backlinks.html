{{/*
  layouts/partials/backlinks.html
  
  This partial finds all pages that link to the current page via wikilinks.
  Usage: {{ partial "backlinks.html" . }}
  
  Returns a structure of pages that reference the current page.
*/}}

{{ $currentPage := . }}
{{ $currentSlug := $currentPage.File.BaseFileName | urlize }}

{{/* Store backlinks with relationship context */}}
{{ $backlinks := slice }}

{{/* Scan all pages for wikilinks pointing to current page */}}
{{ range site.RegularPages }}
  {{ $sourcePage := . }}
  {{ $sourceContent := $sourcePage.RawContent }}
  
  {{/* Find all wikilinks in this page's content */}}
  {{ $wikilinks := findRE `\[\[([^\]]+)\]\]` $sourceContent }}
  
  {{ range $wikilinks }}
    {{/* Extract slug from wikilink */}}
    {{ $linkSlug := . | replaceRE `\[\[([^|\]]+).*\]\]` "$1" | urlize }}
    
    {{/* Check if this wikilink points to our current page */}}
    {{ if eq $linkSlug $currentSlug }}
    
    {{/* Extract context around the wikilink using split method */}}
    {{ $beforeContext := "" }}
    {{ $afterContext := "" }}
    {{ $context := "" }}
    
    {{/* Split content by the current wikilink to get before/after */}}
    {{ $parts := split $sourceContent . }}
    {{ if gt (len $parts) 1 }}
        {{ $beforeContext = index $parts 0 }}
        {{ $afterContext = index $parts 1 }}
        
        {{/* Get last 100 chars before and first 100 chars after */}}
        {{ if gt (len $beforeContext) 100 }}
        {{ $beforeContext = substr $beforeContext (sub (len $beforeContext) 100) 100 }}
        {{ end }}
        {{ if gt (len $afterContext) 100 }}
        {{ $afterContext = substr $afterContext 0 100 }}
        {{ end }}
        
        {{ $context = printf "%s%s%s" $beforeContext . $afterContext | lower }}
    {{ else }}
        {{/* Fallback to entire content if split fails */}}
        {{ $context = $sourceContent | lower }}
    {{ end }}
    
    {{/* Infer relationship type from context */}}
    {{ $relType := "mentions" }}
    {{ if or (strings.Contains $context "builds on") (strings.Contains $context "based on") (strings.Contains $context "extends") }}
        {{ $relType = "builds_on" }}
    {{ else if or (strings.Contains $context "challenges") (strings.Contains $context "disagrees") (strings.Contains $context "contrary") }}
        {{ $relType = "challenges" }}
    {{ else if or (strings.Contains $context "see also") (strings.Contains $context "related to") (strings.Contains $context "connects to") }}
        {{ $relType = "connects_to" }}
    {{ end }}
    
    {{/* Extract display text if custom text is used */}}
    {{ $displayText := . | replaceRE `\[\[[^|]*\|([^\]]+)\]\]` "$1" }}
    {{ if eq $displayText . }}
        {{/* No custom text, use the slug */}}
        {{ $displayText = . | replaceRE `\[\[([^|\]]+).*\]\]` "$1" }}
    {{ end }}
    
    {{/* Add to backlinks */}}
    {{ $backlink := dict 
        "page" $sourcePage 
        "type" $relType 
        "context" $context
        "displayText" $displayText
    }}
    {{ $backlinks = $backlinks | append $backlink }}
    {{ end }}
    
  {{ end }}
{{ end }}

{{/* Group backlinks by relationship type */}}
{{ $groupedBacklinks := dict }}
{{ range $backlinks }}
  {{ $relType := .type }}
  {{ $existing := index $groupedBacklinks $relType | default slice }}
  {{ $existing = $existing | append . }}
  {{ $groupedBacklinks = merge $groupedBacklinks (dict $relType $existing) }}
{{ end }}

{{/* Render backlinks if any exist */}}
{{ if gt (len $backlinks) 0 }}
<div class="backlinks">
  <h3>Referenced by</h3>
  
  {{ range $relType, $links := $groupedBacklinks }}
    <div class="backlink-group" data-rel-type="{{ $relType }}">
      {{ if eq $relType "builds_on" }}
        <h4>üèóÔ∏è Built upon by</h4>
      {{ else if eq $relType "challenges" }}
        <h4>‚ö° Challenged by</h4>
      {{ else if eq $relType "connects_to" }}
        <h4>üîó Connected to</h4>
      {{ else }}
        <h4>üí≠ Mentioned in</h4>
      {{ end }}
      
      <ul class="backlink-list">
        {{ range $links }}
          <li class="backlink-item">
            <a href="{{ .page.RelPermalink }}" class="backlink-title">
              {{ .page.Title }}
            </a>
            {{ if .page.Description }}
              <span class="backlink-desc"> ‚Äî {{ .page.Description }}</span>
            {{ end }}
            {{ with .page.Params.growth }}
              <span class="growth-badge growth-{{ . }}">{{ . }}</span>
            {{ end }}
          </li>
        {{ end }}
      </ul>
    </div>
  {{ end }}
</div>
{{ end }}
