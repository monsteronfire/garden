{{/*
  layouts/partials/backlinks.html
  
  This partial finds all pages that link to the current page via wikilinks.
  Usage: {{ partial "backlinks.html" . }}
  
  Returns a structure of pages that mention the current page.
*/}}

{{ $currentSlug := .Slug}}

{{/* Store backlinks */}}
{{ $backlinks := slice }}

{{/* Scan all pages for wikilinks pointing to current page */}}
{{ range site.RegularPages }}
  {{ $sourcePage := . }}
  {{ $sourceContent := $sourcePage.RawContent }}
  
  {{/* Find all wikilinks in this page's content */}}
  {{ $wikilinks := findRE `\[\[([^\]]+)\]\]` $sourceContent }}
  
  {{ range $wikilinks }}
    {{/* Extract slug from wikilink */}}
    {{ $linkSlug := . | replaceRE `\[\[([^|\]]+).*\]\]` "$1" | urlize }}
    
    {{/* Check if this wikilink points to our current page */}}
    {{ if eq $linkSlug $currentSlug }}
    
    {{/* Extract context around the wikilink using split method */}}
    {{ $beforeContext := "" }}
    {{ $afterContext := "" }}
    {{ $context := "" }}
    
    {{/* Split content by the current wikilink to get before/after */}}
    {{ $parts := split $sourceContent . }}
    {{ if gt (len $parts) 1 }}
        {{ $beforeContext = index $parts 0 }}
        {{ $afterContext = index $parts 1 }}
        
        {{/* Get last 100 chars before and first 100 chars after */}}
        {{ if gt (len $beforeContext) 100 }}
        {{ $beforeContext = substr $beforeContext (sub (len $beforeContext) 100) 100 }}
        {{ end }}
        {{ if gt (len $afterContext) 100 }}
        {{ $afterContext = substr $afterContext 0 100 }}
        {{ end }}
        
        {{ $context = printf "%s%s%s" $beforeContext . $afterContext }}
    {{ else }}
        {{/* Fallback to entire content if split fails */}}
        {{ $context = $sourceContent }}
    {{ end }}
    
    {{/* Extract display text if custom text is used */}}
    {{ $displayText := . | replaceRE `\[\[[^|]*\|([^\]]+)\]\]` "$1" }}
    {{ if eq $displayText . }}
        {{/* No custom text, use the slug */}}
        {{ $displayText = . | replaceRE `\[\[([^|\]]+).*\]\]` "$1" }}
    {{ end }}
    
    {{/* Add to backlinks */}}
    {{ $backlink := dict 
        "page" $sourcePage 
        "context" $context
        "displayText" $displayText
    }}
    {{ $backlinks = $backlinks | append $backlink }}
    {{ end }}

  {{ end }}
{{ end }}

{{/* Render backlinks if any exist */}}
{{ if gt (len $backlinks) 0 }}
<div class="backlinks">
  <h3>ðŸ’­ Mentioned in</h3>
  
  <ul class="backlink-list">
    {{ range $backlinks }}
      <li class="backlink">
        <a href="{{ .page.RelPermalink }}" class="backlink__title">
          {{ .page.Title }}
        </a>
        {{ if .page.Description }}
          <span class="backlink__desc"> â€” {{ .page.Description }}</span>
        {{ end }}
        {{ with .page.Params.growth_stage }}
          <span class="growthbadge growth__{{ . }}">{{ . }}</span>
        {{ end }}
      </li>
    {{ end }}
  </ul>
</div>
{{ end }}
