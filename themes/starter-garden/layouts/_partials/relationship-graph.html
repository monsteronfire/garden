{{ $graphData := dict "nodes" (slice) "links" (slice) }}
{{ $nodes := slice }}
{{ $links := slice }}

{{/* Collect all pages that have content (potential nodes) */}}
{{ range .Site.RegularPages }}
  {{ $node := dict 
    "id" .File.BaseFileName
    "title" .Title
    "url" .RelPermalink
    "growth" (.Params.growth_stage | default "seed")
    "content_type" .Type
  }}
  {{ $nodes = $nodes | append $node }}
{{ end }}

{{/* Scan all pages for wikilinks to create relationships */}}
{{ range .Site.RegularPages }}
  {{ $sourcePage := . }}
  {{ $sourceSlug := $sourcePage.File.BaseFileName }}
  {{ $sourceContent := $sourcePage.RawContent }}
  
  {{/* Find all wikilinks in this page's content */}}
  {{ $wikilinks := findRE `\[\[([^\]]+)\]\]` $sourceContent }}
  
  {{ range $wikilinks }}
    {{/* Extract slug from wikilink */}}
    {{ $targetSlug := . | replaceRE `\[\[([^|\]]+).*\]\]` "$1" | urlize }}
    
    {{/* Skip self-references */}}
    {{ if ne $sourceSlug $targetSlug }}
      {{/* Extract context around the wikilink to infer relationship type */}}
      {{ $context := "" }}
      {{ $relType := "connects_to" }} {{/* default relationship type */}}
      
      {{/* Split content by the current wikilink to get context */}}
      {{ $parts := split $sourceContent . }}
      {{ if gt (len $parts) 1 }}
        {{ $beforeContext := index $parts 0 }}
        {{ $afterContext := index $parts 1 }}
        
        {{/* Get last 200 chars before and first 200 chars after for context */}}
        {{ if gt (len $beforeContext) 200 }}
          {{ $beforeContext = substr $beforeContext (sub (len $beforeContext) 200) 200 }}
        {{ end }}
        {{ if gt (len $afterContext) 200 }}
          {{ $afterContext = substr $afterContext 0 200 }}
        {{ end }}
        
        {{ $context = printf "%s %s %s" $beforeContext . $afterContext | lower }}
        
        {{/* Infer relationship type from context */}}
        {{ if or (strings.Contains $context "builds on") (strings.Contains $context "based on") (strings.Contains $context "extends") (strings.Contains $context "follows from") }}
          {{ $relType = "builds_on" }}
        {{ else if or (strings.Contains $context "challenges") (strings.Contains $context "disagrees") (strings.Contains $context "contrary") (strings.Contains $context "refutes") }}
          {{ $relType = "challenges" }}
        {{ else }}
          {{ $relType = "connects_to" }}
        {{ end }}
      {{ end }}
      
      {{/* Verify target page exists in our nodes */}}
      {{ $targetExists := false }}
      {{ range $nodes }}
        {{ if eq .id $targetSlug }}
          {{ $targetExists = true }}
        {{ end }}
      {{ end }}
      
      {{/* Only create link if target page exists */}}
      {{ if $targetExists }}
        {{ $link := dict
          "source" $sourceSlug
          "target" $targetSlug
          "type" $relType
        }}
        {{ $links = $links | append $link }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="container">
  <h2>üå± Digital Garden Connection Graph</h2>
  
  <div class="controls">
      <div class="filter-group">
          <label>Growth Stage</label>
          <select id="growthFilter">
              <option value="all">All Stages</option>
              <option value="seed">üå± Seed</option>
              <option value="sprout">üåø Sprout</option>
              <option value="bloom">üå∏ Bloom</option>
          </select>
      </div>
      
      <div class="filter-group">
          <label>Content Type</label>
          <select id="contentFilter">
              <option value="all">All Types</option>
              <option value="note">üìù Note</option>
              <option value="bookmark">üîó Bookmark</option>
              <option value="essay">üìÑ Essay</option>
              <option value="portrait">üñºÔ∏è Portrait</option>
              <option value="project">üìÅ Project</option>
          </select>
      </div>
      
      <div class="filter-group">
          <label>Actions</label>
          <button onclick="resetFilters()">Reset Filters</button>
          <button onclick="centerGraph()">Center Graph</button>
      </div>
  </div>
  
  <div class="relationship-graph" data-nodes="{{ $nodes | jsonify }}" data-links="{{ $links | jsonify }}">
      <svg id="graph"></svg>
      <div class="legend">
          <h4>Legend</h4>
          <div>
              <strong>Growth Stage Colours:</strong>
              <div class="legend-item">
                  <div class="legend-color" style="background: #2ecc71"></div>
                  <span>Seed</span>
              </div>
              <div class="legend-item">
                  <div class="legend-color" style="background: #f1c40f"></div>
                  <span>Sprout</span>
              </div>
              <div class="legend-item">
                  <div class="legend-color" style="background: #e74c3c"></div>
                  <span>Bloom</span>
              </div>
          </div>
          <div style="margin-top: 15px;">
              <strong>Content types:</strong>
              <div class="legend-item">
                  <div class="legend-line" style="background: #2ecc71"></div>
                  <span>Note</span>
              </div>
              <div class="legend-item">
                  <div class="legend-line" style="background: #3498db"></div>
                  <span>Essay</span>
              </div>
              <div class="legend-item">
                  <div class="legend-line" style="background: #e74c3c"></div>
                  <span>Bookmark</span>
              </div>
              <div class="legend-item">
                  <div class="legend-line" style="background: #e74c3c"></div>
                  <span>Portrait</span>
              </div>
              <div class="legend-item">
                  <div class="legend-line" style="background: #e74c3c"></div>
                  <span>Project</span>
              </div>
          </div>
      </div>
  </div>
</div>

<div class="tooltip" id="tooltip" style="display: none;"></div>

{{/* Load relationship-graph JavaScript file */}}
{{- $graph := resources.Get "js/relationship-graph.js" }}
{{- if $graph }}
  {{- if hugo.IsDevelopment }}
    <script src="{{ $graph.RelPermalink }}"></script>
  {{- else }}
    {{- with $graph | minify | fingerprint }}
      <script src="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
    {{- end }}
  {{- end }}
{{- end }}
